---
title: 'Teste de Text mining dos Relatórios P-20, P-36 e P-48'
author: "Viviane Schneider, PhD"
date: 'Última versão: hoje'
output:
  html_document:
    highlight: zenburn
    keep_md: yes
    number_sections: yes
    theme: cerulean
    toc: yes
  word_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = FALSE)
```

# Contexto do estudo

Este é um estudo exploratório de técnicas de Text Mining. O intuito é descobrir que técnicas que podem ser utilizadas para identificar fatores humanos em relatórios de acidentes fornecidos pela ANP.

## Objetivo do estudo

Formação de uma base de dados que possa ser utilizada para estimar a probabilidade de ocorrência de um acidente a partir de fatores humanos identificados. Para realizar este estudo foram feitas análises com algoritmos computacionais e análises feitas por humanos. Desta forma busca-se avaliar como um humano identifica determinadas palavras e frases em um texto, para então reproduzir o método em um algoritmo. Como resultado final, espera-se a criação de um método que possa identificar e estruturar em uma base de dados os fatores humanos descritos no modelo HF2.

## Pergunta de pesquisa

Como identificar fatores humanos relacionados ao modelo HF2 nos relatórios de investigação de acidentes da ANP?

## Métodos, técnicas e materiais




# Documento P-20

### Fator linha 51 "Regras e instruções de trabalho projetadas"

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

library(tidyverse) # Manipulacao eficiente de dados
library(tidytext) # Manipulacao eficiente de texto
library(textreadr) # Leitura de pdf para texto
library(tm) # Pacote de mineracao de texto com stopwords 
library(wordcloud) # Grafico nuvem de palavras
library(igraph)
library(ggraph)
library(ggplot2)
library(dplyr)
library(pdftools)
library(RRPP)
library(SnowballC)
library(glue)
library(purrr)
library(magrittr) # needs to be run every time you start R and want to use %>%
library(tibble)
library(reader)


# Match one or more word characters or punctuations


setwd("~/Text Mining")


```              

              

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}


library()
library(tidytext) # Manipulacao eficiente de texto
library(textreadr) # Leitura de pdf para texto
library(tm) # Pacote de mineracao de texto com stopwords 
library(wordcloud) # Grafico nuvem de palavras
library(igraph)
library(ggraph)
library(dplyr)
library(pdftools)
library(RRPP)
library(SnowballC)
library(ggplot2)
library(glue)
library(purrr)
library(magrittr) # needs to be run every time you start R and want to use %>%
library(tibble)
library(reader)
library(readxl)
library(qdap)
modelo_reduzido_greco <- read_excel("modelo_reduzido_greco2.xlsx")
modelo_reduzido_greco_vetores <- read_excel("modelo_reduzido_greco_vetores.xlsx")


.Pdftotext <- function(x){
            library(magrittr)
              Texto <- x %>% 
              read_pdf() %>% 
              tibble() %>% 
              select(text) 
             return(Texto)
}

relatorioExplosao <- .Pdftotext("~/Text Mining/P-48_Relatorio.pdf")





```


.Fator <- function(vetor){
  texto <- relatorioExplosao
  context <- "([\\w[:punct:]]+\\s){0,10}"
   pattern <- glue_collapse(vetor, sep = "|")
   # Add this pattern in front and after the HF_pattern
    pattern_with_context <- glue(
  "{context}({vetor})\\s?{context}")
    frases<-grep(
  texto,
  pattern = pattern_with_context, value = TRUE,ignore.case = TRUE
)
    return(frases)
}

.Fator <- function(vetor){
  texto <- relatorioExplosao
  context <- "([[:punct:]\\w]){0,20}"
   pattern <- glue_collapse(vetor, sep = "|")
   # Add this pattern in front and after the HF_pattern
    pattern_with_context <- glue(
  "{context}({vetor}){context}")
    frases<-grep(
  texto,
  pattern = pattern_with_context, value = TRUE,ignore.case = TRUE
)
    return(frases)
}

    


```{r}

setwd("~/Text Mining")

library(readxl)
modelo_reduzido_greco <- read_excel("modelo_reduzido_greco2.xlsx")
modelo_reduzido_greco_vetores <- read_excel("modelo_reduzido_greco_vetores.xlsx")
relatorioExplosao <- .Pdftotext("~/Text Mining/P-48_Relatorio.pdf")

F22 <- c("Habilidades técnicas-Treinamentos")

context <- "([\\.\\w+]){0,200}"

F22_pattern <- glue_collapse(F22, sep = "|")

# Add this pattern in front and after the HF_pattern
HF_pattern_with_context <- glue(
  "{context}({F22_pattern})\\s?{context}"
)

F22_Decisao <-grep(
  Texto$text,
  pattern = HF_pattern_with_context, value = TRUE,ignore.case = TRUE
)
print(F22_Decisao)

frequency <- freq_terms(
F22_Decisao,
top = 10,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))
```




```{r}

library(qdap)

# Create frequency
frequency <- freq_terms(
F51_Regras_projetadas,
top = 10,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))





```




```{r}

### Fator linha 51 "Regras e instruções de trabalho projetadas"

        

F51_pattern <- glue_collapse(F51, sep = "|")

# Add this pattern in front and after the HF_pattern
HF_pattern_with_context <- glue(
  "{context}({F51_pattern})\\s?{context}"
)

F51_Regras_projetadas <-grep(
  Texto$text,
  pattern = HF_pattern_with_context, value = TRUE,ignore.case = TRUE
)
print(F51_Regras_projetadas)

```

```{r}
library(qdap)

# Create frequency
frequency <- freq_terms(
F51_Regras_projetadas,
top = 10,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))
```


## Fator linha 22: Análise dos riscos na tomada de decisão

```{r}
modelo_reduzido_greco_vetores2 <-list(F22_Decisao = c('tomada\\sde\\sdecisão', 'decisão','decisões'), F87_Lideranca = c('direcionou', 'ineficácia', 'comando', 'coordenação','lideranças?','tomada\\sde\\sdecisão', 'decisão','decisões', 'responsáveis\\spela\\sresposta','comandadas', 'gerencial'))


library(xlsx)


library(xlsx)
for (i in c(1:3)){
   write.xlsx(modelo_reduzido_greco_vetores2[i], file=paste(i,"test.xlsx"))
 }

library(xlsx)
write.xlsx(x, file, sheetName="Sheet1")

F22 <- modelo_reduzido_greco_vetores

context <- "([\\.\\w+]){0,200}"

F22_pattern <- glue_collapse(F22, sep = "|")

# Add this pattern in front and after the HF_pattern
HF_pattern_with_context <- glue(
  "{context}({F22_pattern})\\s?{context}"
)

F22_Decisao <-grep(
  Texto$text,
  pattern = HF_pattern_with_context, value = TRUE,ignore.case = TRUE
)
print(F22_Decisao)

frequency <- freq_terms(
F22_Decisao,
top = 10,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))

```

## Fator linha 87: Trabalho	Relações de Trabalho	Liderança de Equipe	Capacidade de coordenação 


```{r}

F87 <- c('direcionou', 'ineficácia', 'comando', 'coordenação','lideranças?','tomada\\sde\\sdecisão', 'decisão','decisões', 'responsáveis\\spela\\sresposta','comandadas', 'gerencial')

 context <- "([+\\.+\\w+\\.+\\w+]){0,200}"

F87_pattern <- glue_collapse(F87, sep = "|")

# Add this pattern in front and after the HF_pattern
HF_pattern_with_context <- glue(
  "{context}({F87_pattern})\\s?{context}"
)

F87_coordena <-grep(
  Texto$text,
  pattern = HF_pattern_with_context, value = TRUE,ignore.case = TRUE
)
print(F87_coordena)


frequency <- freq_terms(
F87_coordena,
top = 20,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))



```

## Fator linha 58 Trabalho	Condições de Trabalho	Design de interfaces	Inspeção / manutenção

```{r}

F58 <- c('manutenção', 'registro', 'notas')

F58_pattern <- glue_collapse(F58, sep = "|")

# Add this pattern in front and after the HF_pattern
HF_pattern_with_context <- glue(
  "{context}({F58_pattern})\\s?{context}"
)

F58_manutencao<-grep(
  Texto$text,
  pattern = HF_pattern_with_context, value = TRUE,ignore.case = TRUE
)
print(F58_manutencao)

frequency <- freq_terms(
F58_manutencao,
top = 20,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))

```

## Fator linha 104 Organização	Gestão e organização do trabalho 	Gerenciamento de mudanças

```{r}

F104 <- c('gestão\\sde\\smudanças?', 'gerenciamento\\sde\\smudanças?')

F104_pattern <- glue_collapse(F104, sep = "|")

# Add this pattern in front and after the HF_pattern
HF_pattern_with_context <- glue(
  "{context}({F104_pattern})\\s?{context}"
)

F104Gerir_mudanca<-grep(
  Texto$text,
  pattern = HF_pattern_with_context, value = TRUE,ignore.case = TRUE
)
print(F104Gerir_mudanca)

frequency <- freq_terms(
F104Gerir_mudanca,
top = 20,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))


```

## Fator linha 57 Design de interfaces,	Qualidade do equipamento

```{r}

F57 <- c('equipamentos?', 'configuração', 'dimensionamento', 'especificação','rupturas','instalação')

F57_pattern <- glue_collapse(F57, sep = "|")

# Add this pattern in front and after the HF_pattern
HF_pattern_with_context <- glue(
  "{context}({F57_pattern})\\s?{context}"
)

F57_QualiEquipamento<-grep(
  Texto$text,
  pattern = HF_pattern_with_context, value = TRUE,ignore.case = TRUE
)
print(F57_QualiEquipamento)

frequency <- freq_terms(
F57_QualiEquipamento,
top = 20,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))

```

## Fator linha 118 Organização	Gestão e organização do trabalho 	Planejamento e Práticas de trabalho	

```{r}

F118 <- c('trabalho', 'permissão')

F118_pattern <- glue_collapse(F118, sep = "|")

# Add this pattern in front and after the HF_pattern
HF_pattern_with_context <- glue(
  "{context}({F118_pattern})\\s?{context}"
)

F118_PraticaTrabalho<-grep(
  Texto$text,
  pattern = HF_pattern_with_context, value = TRUE,ignore.case = TRUE
)
print(F118_PraticaTrabalho)


frequency <- freq_terms(
F118_PraticaTrabalho,
top = 20,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))

```

## Fator linha 28 Indivíduo	Competência / Repertório de Ações	Habilidades não técnicas	Consciência situacional	Consciência e respeito pelo risco	

```{r}

F28_ConscienciaRespeitoRisco <-  grep(pattern = "[considerção|aprovação|consciência|aprovação|planejamento|segurança|respeito|avaliação|permissão|segurança] (risco)",
             Texto$text, value = TRUE, ignore.case = TRUE)
print(F28_ConscienciaRespeitoRisco)


frequency <- freq_terms(
F28_ConscienciaRespeitoRisco,
top = 20,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))

```

## Fator linha 29 Indivíduo	Competência / Repertório de Ações	Habilidades não técnicas	Consciência situacional	Atenção aos detalhes	Consciência situacional; atenção aos detalhes; falha no monitoramento do trabalho

```{r}

F29_ConscienciaMonitora <-  grep(pattern = "[considerção|consciência|aprovação|planejamento|segurança|respeito|avaliação|permissão|segurança] (monitor.*?)",
             Texto$text, value = TRUE, ignore.case = TRUE)
print(F29_ConscienciaMonitora)

frequency <- freq_terms(
F29_ConscienciaMonitora,
top = 20,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))

```

## Fator linha 52 Trabalho	Condições de Trabalho	Design do trabalho	Carga de trabalho		

```{r}

F52_CargaTrabalho <-  grep(pattern = "alocação|jornada|cansaço|demasiado|trabalhos?",
             Texto$text, value = TRUE, ignore.case = TRUE)
print(F52_CargaTrabalho)


frequency <- freq_terms(
F52_CargaTrabalho,
top = 20,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))

```


## Fator linha 56 Trabalho	Condições de Trabalho	Design de interfaces	Feedback do sistema técnico	


```{r}

F56_FeedbackSistema <-  grep(pattern = ".*feedback|.*sistema.*",
             Texto$text, value = TRUE, ignore.case = TRUE)
print(F56_FeedbackSistema)


frequency <- freq_terms(
F56_FeedbackSistema,
top = 20,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))

```


## Fator linha 61 Trabalho	Condições de Trabalho	Design de interfaces	Informação	Canais de comunicação	


```{r}

F61_Comunicacao <-  grep(pattern = ".*comunicação.*|.*canais?.*|.*rádios?.*|.*esclarecimentos?.*|.*orientação.*",
             Texto$text, value = TRUE, ignore.case = TRUE)
print(F61_Comunicacao)


frequency <- freq_terms(
F61_Comunicacao,
top = 20,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 60,
    colors = c("grey80", "darkgoldenrod1","tomato"))

```

## Fator linha 105 Organização	Gestão e organização do trabalho 	Cultura de segurança 	Prioridade à segurança


```{r}

F105_PriorSeguranca <-  grep(pattern = ".*segurança.*",
             Texto$text, value = TRUE, ignore.case = TRUE)
print(F105_PriorSeguranca)


frequency <- freq_terms(
F105_PriorSeguranca,
top = 20,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 60,
    colors = c("grey80", "darkgoldenrod1","tomato"))

```

##  Grafico do documento

```{r}

Frases <- c(length(F22_Decisao),length(F51_Regras_projetadas), length(F58_manutencao),length(F57_QualiEquipamento),length(F87_coordena),length(F104Gerir_mudanca), length(F118_PraticaTrabalho), length(F28_ConscienciaRespeitoRisco), length(F29_ConscienciaMonitora), length(F52_CargaTrabalho), length(F56_FeedbackSistema), length(F61_Comunicacao), length(F105_PriorSeguranca))
Fatores<-rbind("F22_Decisao","F51_Regras_projetadas", "F58_manutencao","F57_QualiEquipamento","F87_coordena","F104Gerir_mudanca", "F118_PraticaTrabalho","F28_ConscienciaRespeitoRisco","F29_ConscienciaMonitora", "F52_CargaTrabalho","F56_FeedbackSistema", "F61_Comunicacao","F105_PriorSeguranca")
tb_P20 <- data.frame(Fatores, Frases, stringsAsFactors = FALSE)


tb_P20 %>%  
  ggplot(aes(x= Frases , y=Fatores, size = Frases, color=Fatores)) +
    geom_point(alpha=0.5) +
    scale_size(range = c(.1, 20), name="Fatores Humanos")


```

# Documento P-48


```{r}

setwd("~/Text Mining")

# Arquivo pdf
arquivoPdf <- "~/Text Mining/P-48_Relatorio.pdf"

              Texto <- arquivoPdf %>% 
              read_pdf() %>% 
              as.tibble() %>% 
              select(text) 
##Função para encontrar frases dos fatores
              
              ### Fator linha 51 "Regras e instruções de trabalho projetadas"

F51_Regras_projetadas <- grep(
      pattern =  ".*não\\scumpriu.*|.*não\\spossui|.*ausentes?.* .*normas?.*|.*regras?.*|procedimentos?.*", Texto$text, value = TRUE, ignore.case = TRUE)
print(F51_Regras_projetadas)

```

```{r}
library(qdap)

# Create frequency
frequency <- freq_terms(
F51_Regras_projetadas,
top = 10,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))
```


## Fator linha 22: Análise dos riscos na tomada de decisão

```{r}
F22_Decisao <-  grep(
      pattern = ".*falhas?.* .*avaliação.*|.*verificação.*|análises?.*|.*riscos? tomada.*|.*decisão.*|.*decisões", 
      Texto$text, value = TRUE,ignore.case = TRUE)
print(F22_Decisao)

frequency <- freq_terms(
F22_Decisao,
top = 10,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))

```

## Fator linha 87: Trabalho	Relações de Trabalho	Liderança de Equipe	Capacidade de coordenação 


```{r}

F87_coordena <- grep(pattern = "(.*direcionou.*|.*ineficácia.*|.*comando.*|.*coordenação.*|.*liderança?.*|.*decisão.*|.*decisões.*)|(.*devida|responsáveis.*)", 
             Texto$text, value = TRUE,ignore.case = TRUE)
print(F87_coordena)

frequency <- freq_terms(
F87_coordena,
top = 10,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))



```

## Fator linha 58 Trabalho	Condições de Trabalho	Design de interfaces	Inspeção / manutenção

```{r}

F58_manutencao <- grep(
      pattern = ".*manutenção*.|.*registro.*|.*notas.* .*manutenção.*|.*notas.* .*manutenção.*", 
      Texto$text, ,ignore.case = TRUE, value = TRUE)
print(F58_manutencao)

frequency <- freq_terms(
F58_manutencao,
top = 20,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))

```

## Fator linha 104 Organização	Gestão e organização do trabalho 	Gerenciamento de mudanças

```{r}


F104Gerir_mudanca <- grep(
      pattern = ".*gestão\\sde\\smudanças?.*|.*gerenciamento\\sde\\smudanças?.*",
      Texto$text, ignore.case = TRUE, value = TRUE)
print(F104Gerir_mudanca)

frequency <- freq_terms(
F104Gerir_mudanca,
top = 20,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))


```

## Fator linha 57 Design de interfaces,	Qualidade do equipamento

```{r}

F57_QualiEquipamento <-  grep(
      pattern = "(.*falhas?\\sdos?\\sequipamentos?.*)|.*salvaguarda\\sinadequadas?.*|.*configuração\\sinadequadas?.*|.*falhas?\\sna\\sespecificação.*|.*dimensionamento.*|.*rupturas?\\sde\\sequipamentos?.*|.*falhas?\\sdos\\sequipamentos?.*|.*instalaçãoã|.*inadequada|.*funcionamento\\sdas?.*", Texto$text, value = TRUE,ignore.case = TRUE)
print(F57_QualiEquipamento)

frequency <- freq_terms(
F57_QualiEquipamento,
top = 20,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))

```

## Fator linha 118 Organização	Gestão e organização do trabalho 	Planejamento e Práticas de trabalho	

```{r}

F118_PraticaTrabalho <-  grep(pattern = "[^.].*trabalho|permissão.*[\\.$]",
             Texto$text, value = TRUE, ignore.case = TRUE)
print(F118_PraticaTrabalho)

frequency <- freq_terms(
F118_PraticaTrabalho,
top = 20,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))

```

## Fator linha 28 Indivíduo	Competência / Repertório de Ações	Habilidades não técnicas	Consciência situacional	Consciência e respeito pelo risco	

```{r}

F28_ConscienciaRespeitoRisco <-  grep(pattern = "[considerção|aprovação|consciência|aprovação|planejamento|segurança|respeito|avaliação|permissão|segurança] (risco)",
             Texto$text, value = TRUE, ignore.case = TRUE)
print(F28_ConscienciaRespeitoRisco)

frequency <- freq_terms(
F28_ConscienciaRespeitoRisco,
top = 20,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))

```

## Fator linha 29 Indivíduo	Competência / Repertório de Ações	Habilidades não técnicas	Consciência situacional	Atenção aos detalhes	Consciência situacional; atenção aos detalhes; falha no monitoramento do trabalho

```{r}

F29_ConscienciaMonitora <-  grep(pattern = "[considerção|consciência|aprovação|planejamento|segurança|respeito|avaliação|permissão|segurança] (monitor.*?)",
             Texto$text, value = TRUE, ignore.case = TRUE)
print(F29_ConscienciaMonitora)

frequency <- freq_terms(
F29_ConscienciaMonitora,
top = 20,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))

```

## Fator linha 52 Trabalho	Condições de Trabalho	Design do trabalho	Carga de trabalho		

```{r}

F52_CargaTrabalho <-  grep(pattern = "alocação|jornada|cansaço|demasiado|trabalhos?",
             Texto$text, value = TRUE, ignore.case = TRUE)
print(F52_CargaTrabalho)


frequency <- freq_terms(
F52_CargaTrabalho,
top = 20,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))

```


## Fator linha 56 Trabalho	Condições de Trabalho	Design de interfaces	Feedback do sistema técnico	


```{r}

F56_FeedbackSistema <-  grep(pattern = ".*feedback|.*sistema.*",
             Texto$text, value = TRUE, ignore.case = TRUE)
print(F56_FeedbackSistema)


frequency <- freq_terms(
F56_FeedbackSistema,
top = 20,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))

```


## Fator linha 61 Trabalho	Condições de Trabalho	Design de interfaces	Informação	Canais de comunicação	


```{r}

F61_Comunicacao <-  grep(pattern = ".*comunicação.*|.*canais?.*|.*rádios?.*|.*esclarecimentos?.*|.*orientação.*",
             Texto$text, value = TRUE, ignore.case = TRUE)
print(F61_Comunicacao)


frequency <- freq_terms(
F61_Comunicacao,
top = 20,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 60,
    colors = c("grey80", "darkgoldenrod1","tomato"))

```

## Fator linha 105 Organização	Gestão e organização do trabalho 	Cultura de segurança 	Prioridade à segurança


```{r}

F105_PriorSeguranca <-  grep(pattern = ".*segurança.*",
             Texto$text, value = TRUE, ignore.case = TRUE)
print(F105_PriorSeguranca)


frequency <- freq_terms(
F105_PriorSeguranca,
top = 20,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 60,
    colors = c("grey80", "darkgoldenrod1","tomato"))

```

##  Grafico do documento

```{r}

Frases <- c(length(F22_Decisao),length(F51_Regras_projetadas), length(F58_manutencao),length(F57_QualiEquipamento),length(F87_coordena),length(F104Gerir_mudanca), length(F118_PraticaTrabalho), length(F28_ConscienciaRespeitoRisco), length(F29_ConscienciaMonitora), length(F52_CargaTrabalho), length(F56_FeedbackSistema), length(F61_Comunicacao), length(F105_PriorSeguranca))
Fatores<-rbind("F22_Decisao","F51_Regras_projetadas", "F58_manutencao","F57_QualiEquipamento","F87_coordena","F104Gerir_mudanca", "F118_PraticaTrabalho","F28_ConscienciaRespeitoRisco","F29_ConscienciaMonitora", "F52_CargaTrabalho","F56_FeedbackSistema", "F61_Comunicacao","F105_PriorSeguranca")
tb_P48 <- data.frame(Fatores, Frases, stringsAsFactors = FALSE)


tb_P48 %>%  
  ggplot(aes(x= Frases , y=Fatores, size = Frases, color=Fatores)) +
    geom_point(alpha=0.5) +
    scale_size(range = c(.1, 20), name="Fatores Humanos")


```




# Documento P-36


```{r}

setwd("~/Text Mining")

# Arquivo pdf
arquivoPdf <- "~/Text Mining/Relatorio_P-36.pdf"

              Texto <- arquivoPdf %>% 
              read_pdf() %>% 
              as.tibble() %>% 
              select(text) 
##Função para encontrar frases dos fatores
              
              ### Fator linha 51 "Regras e instruções de trabalho projetadas"

F51_Regras_projetadas <- grep(
      pattern =  ".*não\\scumpriu.*|.*não\\spossui|.*ausentes?.* .*normas?.*|.*regras?.*|procedimentos?.*", Texto$text, value = TRUE, ignore.case = TRUE)
print(F51_Regras_projetadas)


library(qdap)

# Create frequency
frequency <- freq_terms(
F51_Regras_projetadas,
top = 10,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))
```


## Fator linha 22: Análise dos riscos na tomada de decisão

```{r}
F22_Decisao <-  grep(
      pattern = ".*falhas?.* .*avaliação.*|.*verificação.*|análises?.*|.*riscos? tomada.*|.*decisão.*|.*decisões", 
      Texto$text, value = TRUE,ignore.case = TRUE)
print(F22_Decisao)

frequency <- freq_terms(
F22_Decisao,
top = 10,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))

```

## Fator linha 87: Trabalho	Relações de Trabalho	Liderança de Equipe	Capacidade de coordenação 


```{r}

F87_coordena <- grep(pattern = "(.*direcionou.*|.*ineficácia.*|.*comando.*|.*coordenação.*|.*liderança?.*|.*decisão.*|.*decisões.*)|(.*devida|responsáveis.*)", 
             Texto$text, value = TRUE,ignore.case = TRUE)
print(F87_coordena)

frequency <- freq_terms(
F87_coordena,
top = 10,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))



```

## Fator linha 58 Trabalho	Condições de Trabalho	Design de interfaces	Inspeção / manutenção

```{r}

F58_manutencao <- grep(
      pattern = ".*manutenção*.|.*registro.*|.*notas.* .*manutenção.*|.*notas.* .*manutenção.*", 
      Texto$text, ,ignore.case = TRUE, value = TRUE)
print(F58_manutencao)

frequency <- freq_terms(
F58_manutencao,
top = 20,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))

```

## Fator linha 104 Organização	Gestão e organização do trabalho 	Gerenciamento de mudanças

```{r message=FALSE, warning=FALSE}

F104Gerir_mudanca <- grep(
      pattern = ".*mudanças?.*",
      Texto$text, ignore.case = TRUE, value = TRUE)
print(F104Gerir_mudanca)




```

## Fator linha 57 Design de interfaces,	Qualidade do equipamento

```{r}

F57_QualiEquipamento <-  grep(
      pattern = "(.*falhas?\\sdos?\\sequipamentos?.*)|.*salvaguarda\\sinadequadas?.*|.*configuração\\sinadequadas?.*|.*falhas?\\sna\\sespecificação.*|.*dimensionamento.*|.*rupturas?\\sde\\sequipamentos?.*|.*falhas?\\sdos\\sequipamentos?.*|.*instalaçãoã|.*inadequada|.*funcionamento\\sdas?.*", Texto$text, value = TRUE,ignore.case = TRUE)
print(F57_QualiEquipamento)

frequency <- freq_terms(
F57_QualiEquipamento,
top = 20,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))

```

## Fator linha 118 Organização	Gestão e organização do trabalho 	Planejamento e Práticas de trabalho	

```{r}

F118_PraticaTrabalho <-  grep(pattern = "[^.].*trabalho|permissão.*[\\.$]",
             Texto$text, value = TRUE, ignore.case = TRUE)
print(F118_PraticaTrabalho)



```

## Fator linha 28 Indivíduo	Competência / Repertório de Ações	Habilidades não técnicas	Consciência situacional	Consciência e respeito pelo risco	

```{r}

F28_ConscienciaRespeitoRisco <-  grep(pattern = "[considerção|aprovação|consciência|aprovação|planejamento|segurança|respeito|avaliação|permissão|segurança] (risco)",
             Texto$text, value = TRUE, ignore.case = TRUE)
print(F28_ConscienciaRespeitoRisco)

frequency <- freq_terms(
F28_ConscienciaRespeitoRisco,
top = 20,
at.least = 1,
stopwords("pt"))

wordcloud(frequency$WORD,frequency$FREQ,
    max.words = 80,
    colors = c("grey80", "darkgoldenrod1","tomato"))

```

## Fator linha 29 Indivíduo	Competência / Repertório de Ações	Habilidades não técnicas	Consciência situacional	Atenção aos detalhes	Consciência situacional; atenção aos detalhes; falha no monitoramento do trabalho

```{r}

F29_ConscienciaMonitora <-  grep(pattern = "[considerção|consciência|aprovação|planejamento|segurança|respeito|avaliação|permissão|segurança] (monitor.*?)",
             Texto$text, value = TRUE, ignore.case = TRUE)
print(F29_ConscienciaMonitora)


```

## Fator linha 52 Trabalho	Condições de Trabalho	Design do trabalho	Carga de trabalho		

```{r}

F52_CargaTrabalho <-  grep(pattern = "alocação|jornada|cansaço|demasiado|trabalhos?",
             Texto$text, value = TRUE, ignore.case = TRUE)
print(F52_CargaTrabalho)



```


## Fator linha 56 Trabalho	Condições de Trabalho	Design de interfaces	Feedback do sistema técnico	


```{r}

F56_FeedbackSistema <-  grep(pattern = ".*feedback|.*sistema.*",
             Texto$text, value = TRUE, ignore.case = TRUE)
print(F56_FeedbackSistema)



```


## Fator linha 61 Trabalho	Condições de Trabalho	Design de interfaces	Informação	Canais de comunicação	


```{r}

F61_Comunicacao <-  grep(pattern = ".*comunicação.*|.*canais?.*|.*rádios?.*|.*esclarecimentos?.*|.*orientação.*",
             Texto$text, value = TRUE, ignore.case = TRUE)
print(F61_Comunicacao)




```

## Fator linha 105 Organização	Gestão e organização do trabalho 	Cultura de segurança 	Prioridade à segurança


```{r}

F105_PriorSeguranca <-  grep(pattern = ".*segurança.*",
             Texto$text, value = TRUE, ignore.case = TRUE)
print(F105_PriorSeguranca)




```

##  Grafico do documento

```{r}

Frases <- c(length(F22_Decisao),length(F51_Regras_projetadas), length(F58_manutencao),length(F57_QualiEquipamento),length(F87_coordena),length(F104Gerir_mudanca), length(F118_PraticaTrabalho), length(F28_ConscienciaRespeitoRisco), length(F29_ConscienciaMonitora), length(F52_CargaTrabalho), length(F56_FeedbackSistema), length(F61_Comunicacao), length(F105_PriorSeguranca))
Fatores<-rbind("F22_Decisao","F51_Regras_projetadas", "F58_manutencao","F57_QualiEquipamento","F87_coordena","F104Gerir_mudanca", "F118_PraticaTrabalho","F28_ConscienciaRespeitoRisco","F29_ConscienciaMonitora", "F52_CargaTrabalho","F56_FeedbackSistema", "F61_Comunicacao","F105_PriorSeguranca")
tb_P36 <- data.frame(Fatores, Frases, stringsAsFactors = FALSE)


tb_P36 %>%  
  ggplot(aes(x= Frases , y=Fatores, size = Frases, color=Fatores)) +
    geom_point(alpha=0.5) +
    scale_size(range = c(.1, 20), name="Fatores Humanos")


```




# Comparativo por Fatores

```{r}
tb_P36 <- mutate(tb_P36, Acidente = "P-36")
tb_P48 <- mutate(tb_P48, Acidente = "P-48")
tb_P20 <- mutate(tb_P20, Acidente = "P-20")  

todos1 <- merge(tb_P36, tb_P48, all = TRUE)

data <- merge(todos1, tb_P20, all = TRUE)

names(data) <- c("individual","value","group")



# library
library(tidyverse)
 

# Set a number of 'empty bar' to add at the end of each group
empty_bar <- 4
to_add <- data.frame( matrix(NA, empty_bar*nlevels(data$group), ncol(data)) )
colnames(to_add) <- colnames(data)
to_add$group <- rep(levels(data$group), each=empty_bar)
data <- rbind(data, to_add)
data <- data %>% arrange(group)
data$id <- seq(1, nrow(data))
 
# Get the name and the y position of each label
label_data <- data
number_of_bar <- nrow(label_data)
angle <- 90 - 360 * (label_data$id-0.5) /number_of_bar     # I substract 0.5 because the letter must have the angle of the center of the bars. Not extreme right(1) or extreme left (0)
label_data$hjust <- ifelse( angle < -90, 1, 0)
label_data$angle <- ifelse(angle < -90, angle+180, angle)
 
# Make the plot
p <- ggplot(data, aes(x=as.factor(id), y=value, fill=group)) +       # Note that id is a factor. If x is numeric, there is some space between the first bar
  geom_bar(stat="identity", alpha=0.5) +
  ylim(-100,120) +
  theme_minimal() +
  theme(
    legend.position = "right",
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    plot.margin = unit(rep(-1,4), "cm") 
  ) +
  coord_polar() + 
  geom_text(data=label_data, aes(x=id, y=value+10, label=individual, hjust=hjust), color="black", fontface="bold",alpha=0.6, size=2.5, angle= label_data$angle, inherit.aes = FALSE ) 
 
p

```

# Comparativo por Acidente (documento)

```{r}
todos1 <- merge(tb_P36, tb_P48, all = TRUE)

data <- merge(todos1, tb_P20, all = TRUE)

names(data) <- c("group","value","individual")
  
# library
library(tidyverse)
 

# Set a number of 'empty bar' to add at the end of each group
empty_bar <- 4
to_add <- data.frame( matrix(NA, empty_bar*nlevels(data$group), ncol(data)) )
colnames(to_add) <- colnames(data)
to_add$group <- rep(levels(data$group), each=empty_bar)
data <- rbind(data, to_add)
data <- data %>% arrange(group)
data$id <- seq(1, nrow(data))
 
# Get the name and the y position of each label
label_data <- data
number_of_bar <- nrow(label_data)
angle <- 90 - 360 * (label_data$id-0.5) /number_of_bar     # I substract 0.5 because the letter must have the angle of the center of the bars. Not extreme right(1) or extreme left (0)
label_data$hjust <- ifelse( angle < -90, 1, 0)
label_data$angle <- ifelse(angle < -90, angle+180, angle)
 
# Make the plot
p2 <- ggplot(data, aes(x=as.factor(id), y=value, fill=group)) +       # Note that id is a factor. If x is numeric, there is some space between the first bar
  geom_bar(stat="identity", alpha=0.5) +
  ylim(-100,120) +
  theme_minimal() +
  theme(
    legend.position = "right",
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    plot.margin = unit(rep(-1,4), "cm") 
  ) +
  coord_polar() + 
  geom_text(data=label_data, aes(x=id, y=value+10, label=individual, hjust=hjust), color="black", fontface="bold",alpha=0.6, size=2.5, angle= label_data$angle, inherit.aes = FALSE ) 
 
p2

```



```{r}
library(packcircles)
library(ggplot2)
 
 
 
# Generate the layout. This function return a dataframe with one line per bubble. 
# It gives its center (x and y) and its radius, proportional of the value
packing <- circleProgressiveLayout(data$value, sizetype='area')
 
# We can add these packing information to the initial data frame
data <- cbind(data, packing)
 
# Check that radius is proportional to value. We don't want a linear relationship, since it is the AREA that must be proportionnal to the value
# plot(data$radius, data$value)
 
# The next step is to go from one center + a radius to the coordinates of a circle that
# is drawn by a multitude of straight lines.
dat.gg <- circleLayoutVertices(packing, npoints=50)
 
# Make the plot
ggplot() + 
  
  # Make the bubbles
  geom_polygon(data = dat.gg, aes(x, y, group = id, fill=as.factor(id)), colour = "black", alpha = 0.6) +
  
  # Add text in the center of each bubble + control its size
  geom_text(data = data, aes(x, y, size=value, label = group)) +
  scale_size_continuous(range = c(1,4)) +
  
  # General theme:
  theme_void() + 
  theme(legend.position="right") +
  coord_equal()


```




```{r}
names(data) <- c("fator_humano","percentual","plataforma")

ggplot(data, aes(fill=fator_humano, y=plataforma, x=percentual)) + 
    geom_bar(position="fill", stat="identity") + ggtitle("Fatores humanos por relatório de acidente")

```



```{r}
names(data) <- c("fator_humano","percentual","plataforma")

ggplot(data, aes(fill=plataforma, y=fator_humano, x=percentual)) + 
    geom_bar(position="fill", stat="identity") + ggtitle("Fatores humanos por relatório de acidente")

```




# Referências

National Commission on the BP Deepwater Horizon Oil Spill and Offshore Drilling (NCDWHSOD). Deep Water: The Gulf Oil Disaster and the Future of Offshore Drilling. Report to the President. January 2011 Cover Photo: © Steadfast TV. ISBN: 978-0-16-087371-3. https://www.govinfo.gov/content/pkg/GPO-OILCOMMISSION/pdf/GPO-OILCOMMISSION.pdf

http://data7.blog/grafo-de-palavras-anitta-twitter/

Analise de palavras.  Disponivel em: https://www.ufrgs.br/wiki-r/index.php?title=Frequ%C3%AAncia_das_palavras_e_nuvem_de_palavras Esta página foi modificada pela última vez em 12 de dezembro de 2018, às 19h30min
Conteúdo disponível sob Creative Commons - Atribuição - Compartilha nos Mesmos Termos, salvo indicação em contrário.

https://p4husp.github.io/material/tutorial11/


Principal: https://www.tidytextmining.com/ngrams.html

Corpus and Machine Learning: https://rstudio-pubs-static.s3.amazonaws.com/265713_cbef910aee7642dc8b62996e38d2825d.html


Machine learning: https://kenbenoit.net/pdfs/text_analysis_in_R.pdf

Mineração de texto: 
https://www.rpubs.com/LaionBoaventura/mineracaodetexto

MANIPULAÇÃO DE STRINGS E TEXT MININGhttps://gomesfellipe.github.io/post/2017-12-17-string/string/


@article{JSSv025i05,
   author = {Ingo Feinerer and Kurt Hornik and David Meyer},
   title = {Text Mining Infrastructure in R},
   journal = {Journal of Statistical Software, Articles},
   volume = {25},
   number = {5},
   year = {2008},
   keywords = {},
   abstract = {During the last decade text mining has become a widely used   discipline utilizing statistical and machine learning methods. We  present the tm package which provides a framework for text mining  applications within R. We give a survey on text mining facilities in R and explain how typical application tasks can be carried out using our framework. We present techniques for count-based analysis methods, text clustering, text classification and string kernels.},
   issn = {1548-7660},
   pages = {1--54},
   doi = {10.18637/jss.v025.i05},
   url = {https://www.jstatsoft.org/v025/i05}
}

